# Nazwa pipeline'u (widoczna w UI)
name: $(Date:yyyyMMdd)$(Rev:.r)-$(SourceBranchName)

# Uruchamianie tylko na tagach (np. v1.18.0)
# To najbezpieczniejsza metoda na release produkcyjny
trigger:
  tags:
    include:
      - v*

# Używamy najnowszego Ubuntu
pool:
  vmImage: 'ubuntu-latest'

# Zmienne - token pobieramy z Library
variables:
  - group: vscode-marketplace-secrets

steps:
# 1. Instalacja Node.js (wersja 22.x, bo tak masz w @types/node)
- task: NodeTool@0
  inputs:
    versionSpec: '22.x'
  displayName: 'Install Node.js'

# 2. Instalacja zależności (npm ci jest szybsze i bezpieczniejsze niż npm install)
- script: |
    npm ci
  displayName: 'Install Dependencies'

# 3. Budowanie (Compile & Lint)
# Twój skrypt "package" robi: check-types, lint, esbuild --production, compile:server
# To jest idealne, bo zawiera weryfikację typów i lintera.
- script: |
    npm run package
  displayName: 'Build & Package Assets'

# 4. Instalacja vsce (narzędzie do tworzenia .vsix)
- script: |
    npm install -g @vscode/vsce
  displayName: 'Install vsce'

# 5. Tworzenie pliku .vsix
# Tworzymy artefakt, który można pobrać z Azure DevOps (na wypadek rollbacku)
- script: |
    vsce package --out smart-indexer.vsix
  displayName: 'Create VSIX Package'

# 6. Publikacja artefaktu w Azure DevOps (żebyś mógł go pobrać ręcznie)
- task: PublishPipelineArtifact@1
  inputs:
    targetPath: 'smart-indexer.vsix'
    artifact: 'ExtensionFile'
    publishLocation: 'pipeline'
  displayName: 'Upload VSIX Artifact'

# 7. Publikacja do VS Code Marketplace
# Warunek: Tylko jeśli poprzednie kroki się udały i jest to tag (release)
- script: |
    vsce publish -p $(VSCODE_MARKETPLACE_TOKEN) --packagePath smart-indexer.vsix
  displayName: 'Publish to Marketplace'
  condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/tags/'))
